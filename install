#!/usr/bin/env bash

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "Setting up Waves audio synthesis environment..."
echo

# Check Python version
PYTHON_VERSION=$(python3 -c 'import sys; print(f"{sys.version_info.major}.{sys.version_info.minor}")')
REQUIRED_VERSION="3.10"

echo "Detected Python version: $PYTHON_VERSION"

# Compare versions (converts to integers for comparison)
CURRENT_VER=$(echo $PYTHON_VERSION | awk -F. '{print ($1 * 100) + $2}')
REQUIRED_VER=$(echo $REQUIRED_VERSION | awk -F. '{print ($1 * 100) + $2}')

if [[ $CURRENT_VER -lt $REQUIRED_VER ]]; then
    echo "✗ Error: Python $REQUIRED_VERSION or higher is required"
    echo "  Current version: $PYTHON_VERSION"
    echo "  Please upgrade Python and try again"
    exit 1
fi

echo "✓ Python version is compatible"
echo

# Check if virtual environment exists
if [[ ! -d "$SCRIPT_DIR/venv" ]]; then
    echo "Creating virtual environment..."
    python3 -m venv "$SCRIPT_DIR/venv"
    if [[ $? -ne 0 ]]; then
        echo "Error: Failed to create virtual environment"
        exit 1
    fi
    echo "✓ Virtual environment created"
else
    echo "✓ Virtual environment already exists"
fi

echo

# Activate virtual environment
source "$SCRIPT_DIR/venv/bin/activate"

# Upgrade pip
echo "Upgrading pip..."
pip install --upgrade pip > /dev/null 2>&1
echo "✓ pip upgraded"

echo

# Install dependencies
echo "Installing dependencies from requirements.txt..."
pip install -r "$SCRIPT_DIR/requirements.txt"

if [[ $? -eq 0 ]]; then
    ./play success
    echo
    echo "✓ Installation complete!"
    echo
else
    echo
    echo "✗ Installation failed. Please check the error messages above."
    exit 1
fi
