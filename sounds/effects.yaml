

# Dynamic compressor with envelope follower
# Usage as sub-patch: compressor: {signal: {...}, threshold: 0.3, ratio: 0.7, gain: 1.0}
# The 'signal' parameter is automatically mapped to 'input_signal' for sub-patch compatibility
compressor:
  context:
    input_signal:
      kick_ai: {}
    threshold: 0.3
    ratio: 0.7
    gain: 1.0
    attack: 0.01
    release: 0.1
    signal:
      context:
        env:
          follow:
            range: [0, 1]
            attack: attack
            release: release
            signal: $input_signal
        signal:
          expression:
            exp: "signal * (clip(where(env > threshold, 1 - (env - threshold) / (env + 1e-8) * ratio, 1), 0, 1) * gain).reshape(-1, 1)"
            signal: $input_signal



compressed:
  tempo:
    bpm: 130
    signal:
      compressor:
        gain:
          midi_cc:
            cc: 16
            range: [1, 5]
        release:
          midi_cc:
            cc: 17
            range: [0, 3]
        threshold:
          midi_cc:
            cc: 18
            range: [0, 3]
        ratio:
          midi_cc:
            cc: 19
            range: [0, 3]
        signal:
          mix:
            rumble:
              osc:
                freq: 50
                amp: 0.2
                duration: 999
            perc:
              sequencer:
                interval: beat
                steps:
                  - osc:
                      freq: 100
                      amp: 2
                      duration: 0.5
                      attack: 0.01
                      release: 0.5
                  -
                  -
                  -
                  -
                  -
                  -
                  -