shahi:
  tempo:
    bpm: 130
    signal:
      expression:
        exp: signal * amp
        amp:
          midi_cc:
            monitor: true
            cc: 3
            range: [0.5, 3]
        signal:
          filter:
            type: highpass
            peak:
              midi_cc:
                cc: 20
            cutoff:
              midi_cc:
                cc: 19
                range: [0, 20000]
            signal:
              filter:
                peak:
                  midi_cc:
                    monitor: true
                    cc: 18
                cutoff:
                  midi_cc:
                    monitor: true
                    cc: 17
                    range: [0, 20000]
                signal:
                  expression:
                    monitor: true
                    exp: pow(signal, exponent)
                    exponent:
                      midi_cc:
                        cc: 16
                        range: [0, 2]
                    signal:
                      envelope:
                        gate:
                          osc:
                            type: sqr
                            freq: 1
                        release: 5
                        attack: 0.01
                        signal:
                          tracks:
                            duration: 1000
                            perc:
                              sequencer:
                                monitor: true
                                interval: beat / 4
                                repeat: 1000
                                steps:
                                  - kick-drum-dynamic
                                  - 
                                  - kick-drum-dynamic
                                  -
                                  - 
                                  -
                            drone:
                              osc:
                                type: saw
                                freq: A1
                                amp: 0.005
                            note:
                              osc:
                                monitor: true
                                type: saw
                                freq: E1
                                amp: 0.005
                                phase:
                                  osc:
                                    freq:
                                      midi_cc:
                                        cc: 0
                                        range: [0, 1000]
                                    range:
                                      - midi_cc:
                                          cc: 1
                                          range: [-10, 0]
                                      - midi_cc:
                                          cc: 2
                                          range: [0, 10]

          


kick-drum:
  tracks:
    click:
      osc:
        type: sqr
        freq: 200
        duration: 0.002
        amp: [0.3, 0]
    thump:
      osc:
        freq: [800, [100, 0.1], 100]
        duration: 0.05
        amp: [0.4, 0]
    body:
      osc:
        freq: [100, [50, 0.2], 50]
        duration: 0.2
        amp: [1, 0]


# Test dynamic range with LFO modulating oscillator range
rumble:
  osc:
    type: sin
    freq: 50
    duration: 9999
    range:
      - osc:
          type: sin
          freq: 29
          range:
            - osc:
                type: sin
                freq: 3
                range: [-1, -.1]
            - osc:
                type: sin
                freq: 5
                range: [1, .1]
      - osc:
          type: sin
          freq: 47
          range:
            - osc:
                type: sin
                freq: 13
                range: [-1, -.1]
            - osc:
                type: sin
                freq: 7
                range: [1, .1]


kick-drum-dynamic:
  context:
    tune: 50
    signal:
      tracks:
        click:
          osc:
            type: sqr
            freq: tune * 4
            duration: 0.002
            attack: 0.0001
            amp: [0.3, 0]
        thump:
          osc:
            freq: [tune * 16, [tune * 2, 0.1]]
            duration: 0.1
            attack: 0.2
            amp: [0.8, 0]
            phase:
              osc:
                freq: tune
                range: [0, 1]
        body:
          osc:
            freq: [tune * 6, [tune, 0.12]]
            duration: 0.2
            attack: 0.2
            amp: [1, 0]
            phase:
              osc:
                freq: tune * 0.8
                range: [0, 1]



kick-test:
  tempo:
    bpm: 130
    signal:
      sequencer:
        interval: beat / 4
        repeat: 1000
        steps:
          - kick-drum-dynamic
          - 
          - 
          -


kick-with-rumble:
  tempo:
    bpm: 130
    signal:
      tracks:
        kick:
          sequencer:
            id: kick
            interval: beat / 4
            steps:
              - kick-drum-dynamic
              - 
              - hihat v.1
              -
              - kick-drum-dynamic
              - 
              - glitch
              -
              - kick-drum-dynamic
              - 
              - hihat v.1
              -
              - kick-drum-dynamic
              - 
              - oscar
              -
            # steps:
            #   - kick-drum-dynamic, hihat v.2
            #   - 
            #   - hihat v.1
            #   - 
            steps:
              - kick-drum-dynamic
              - 
              -
              - 
        rumble:
          expression:
            exp: signal * amp
            signal:
              rumble: {}
            amp:
              follow:
                range: [.3, .05]
                release: beat / 16
                signal: $kick * 2


compressed-pow:
  expression:
    exp: pow(signal, 0.5)
    exponent:
      midi_cc:
        cc: 16
        range: [0, 2]

    signal:
      kick-with-rumble: {}

compressor-test:
  expression:
    exp: "signal * (1 - ratio) + clip(signal, -threshold, threshold) * ratio"
    signal:
      kick-with-rumble: {}
    threshold: 0.3
    ratio: 0.7


# Dynamic compressor with envelope follower
# Usage as sub-patch: compressor: {signal: {...}, threshold: 0.3, ratio: 0.7, gain: 1.0}
# The 'signal' parameter is automatically mapped to 'input_signal' for sub-patch compatibility
compressor:
  context:
    input_signal:
      kick-with-rumble: {}
    threshold: 0.3
    ratio: 0.7
    gain: 1.0
    attack: 0.01
    release: 0.1
    signal:
      context:
        env:
          follow:
            range: [0, 1]
            attack: attack
            release: release
            signal: $input_signal
        signal:
          expression:
            exp: "signal * (clip(where(env > threshold, 1 - (env - threshold) / (env + 1e-8) * ratio, 1), 0, 1) * gain).reshape(-1, 1)"
            signal: $input_signal



compressed:
  tempo:
    bpm: 130
    signal:
      compressor:
        gain:
          midi_cc:
            cc: 16
            range: [1, 5]
        release:
          midi_cc:
            cc: 17
            range: [0, 3]
        threshold:
          midi_cc:
            cc: 18
            range: [0, 3]
        ratio:
          midi_cc:
            cc: 19
            range: [0, 3]
        signal:
          tracks:
            rumble:
              osc:
                freq: 50
                amp: 0.2
                duration: 999
            perc:
              sequencer:
                interval: beat
                steps:
                  - osc:
                      freq: 100
                      amp: 2
                      duration: 0.5
                      attack: 0.01
                      release: 0.5
                  -
                  -
                  -
                  -
                  -
                  -
                  -



oscar:
  retrigger:
    duration: 10
    time: 0.3
    repeat: 4
    spread: 0.9
    movement: 4
    signal:
      osc:
        type: tri
        amp: 0.5
        duration: 0.05
        attack: 0.1
        release: 0.1
        freq:
          hold:
            signal: rand([500, 250, 150, 700, 1300, 4000])

chop:
  context:
    c: rand(0, 14)
    signal:
      map:
        from: [-1, 1]
        to: [-6, 6]
        signal:
          sample:
            speed: 2
            file: output/chopped9
            chop: 
              hold:
                signal: c

glitch:
  context:
    c: rand(0, 164)
    signal:
      map:
        from: [-1, 1]
        to: [-1, 1]
        signal:
          sample:
            speed: 2
            file: output/hum_chopped
            chop: 
              hold:
                signal: c

hihat:
  context:
    duration: 1
    v: 1
    signal:
      expression:
        duration: 0.25
        exp: v * signal
        signal:
          # filter:
          #   cutoff: [20000, 200, 100]
          #   signal:
              osc:
                type: noise
                amp: [0.2, [0.07, 0.005], [0, 0.15]]
                attack: 0.001
                release: 1



kick:
  mix:
    duration: 1
    signals:
      # Rumble
      - osc:
          type: sin
          freq: [420, [55, 0.02], [45, 0.15]]
          amp: 0.6
          attack: 0.001
          release: 0.6
          duration: 0.75
      
      # Body
      - osc:
          type: sin
          freq: [150, [55, 0.015]]
          amp: 0.3
          attack: 0.0001
          release: 0.25
          duration: 0.2
          phase:
            osc:
              type: sin
              freq: [250, [85, 0.015]]
              amp: [0.8, [0.1, 0.03]]
              attack: 0.0005
              release: 0.15
              duration: 0.2
      
      # Upper harmonics
      - osc:
          type: tri
          freq: [180, [110, 0.01]]
          amp: 0.01
          attack: 0.001
          release: 0.15
          duration: 0.2
      
      # Punch
      - osc:
          type: noise
          amp: 0.02
          attack: 0.0001
          release: 0.008
          duration: 0.004
      
      # Extra punch
      - osc:
          type: sin
          freq: [3500, [800, 0.003]]
          amp: 0.1
          attack: 0.0001
          release: 0.006
          duration: 0.01
      
      # Sub harmonic
      - osc:
          type: sin
          freq: 40
          amp: 0.4
          attack: 0.002
          release: 0.5
          duration: 0.6

kick2:
  map:
    from: [-1, 1]
    to: [-1.5, 1.5]
    clip: [-1, 1]
    signal:
      mix:
        signals:
          - osc:
              attack: 0.01
              amp: 0.2
              release: 0.5
              duration: 0.3
              freq: [1000, [20, 0.04]]
          - osc:
              type: noise
              amp: 0.02
              attack: 0.0001
              release: 0.02
              duration: 0.01
          - osc:
              amp: 0.5
              attack: 0.2
              release: 0.5
              duration: 0.8
              freq: 50
              phase:
                osc:
                  amp: 0.5
                  attack: 0.1
                  release: 0.5
                  duration: 0.8
                  freq: 50
          - osc:
              type: tri
              amp: 0.02
              attack: 0.01
              release: 0.5
              duration: 0.3
              freq: 100
          - osc:
              type: tri
              amp: 0.005
              attack: 0.01
              release: 0.5
              duration: 0.3
              freq: 130
          - osc:
              type: sqr
              amp: 0.01
              attack: 0.01
              release: 0.5
              duration: 0.4
              freq: 18
